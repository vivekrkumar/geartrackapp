<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GearTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            /* Ensure body and html are full height and allow main content to scroll */
            height: 100vh;
            overflow: hidden;
        }
        html {
            height: 100%;
        }
        #app-container {
            height: 100%; /* Make app container fill the viewport height */
            display: flex;
            flex-direction: column;
        }
        main {
            flex-grow: 1; /* Allow main content to take available space */
            overflow-y: auto; /* Enable vertical scrolling for main content */
            padding-bottom: 5rem; /* Space for fixed bottom nav */
        }
        .fixed-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #262626; /* zinc-800 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #f97316; /* orange-500 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ea580c; /* orange-600 */
        }
    </style>
</head>
<body class="bg-black text-white">

    <div id="app-container">
        <!-- Header -->
        <header class="p-4 bg-orange-600 flex items-center justify-between shadow-lg flex-shrink-0">
            <div class="text-xl font-bold text-white">
                <span role="img" aria-label="tennis racket and ball">🎾</span> GearTrack
            </div>
            <button id="homeButtonHeader" class="p-2 rounded-full hover:bg-orange-700 transition-colors" aria-label="Home">
                <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2 2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </button>
        </header>

        <!-- Main Content Area -->
        <main id="mainContent" class="p-4"></main>

        <!-- AI Commentary Modal -->
        <div id="aiCommentaryModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div class="bg-zinc-900 text-white p-6 rounded-xl shadow-2xl max-w-md w-full relative border-t-4 border-orange-500 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <button id="closeCommentaryModal" class="absolute top-3 right-3 text-2xl text-gray-400 hover:text-white transition-colors" aria-label="Close">
                    &times;
                </button>
                <h2 id="commentaryGearName" class="text-2xl font-bold mb-4 text-orange-400 text-center"></h2>
                <p id="commentaryAiCommentary" class="mb-4 text-gray-200 text-center"></p>

                <div class="flex justify-around items-center gap-4 mb-4">
                    <div class="text-center">
                        <p class="font-semibold text-orange-200 mb-1">Current</p>
                        <img id="commentaryCurrentImage" src="" alt="Current Gear" class="h-24 w-24 object-contain rounded-lg border border-zinc-700 mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/100x100/333333/FFFFFF?text=Image+Error';" />
                    </div>
                    <div class="text-center">
                        <p class="font-semibold text-orange-200 mb-1">Ideal</p>
                        <img id="commentaryIdealImage" src="" alt="Ideal Gear" class="h-24 w-24 object-contain rounded-lg border border-zinc-700 mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/100x100/FF5722/FFFFFF?text=Image+Error';" />
                    </div>
                </div>

                <div id="commentaryInjuries" class="hidden mt-4 p-3 bg-zinc-800 rounded-lg border border-zinc-700">
                    <h4 class="font-semibold text-orange-300 mb-2 text-center">Potential Injury Risks</h4>
                    <div id="injuryList" class="flex flex-wrap justify-center gap-4"></div>
                </div>

                <button id="checkReplacementGearButton" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md w-full mt-6 hover:bg-orange-600 transition-colors duration-300">
                    Check Replacement Gear
                </button>

                <button id="getAiMaintenanceTipsButton" class="bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md w-full mt-4 hover:bg-orange-800 transition-colors duration-300 flex items-center justify-center gap-2">
                    <span id="aiTipsSpinner" class="hidden animate-spin h-5 w-5 text-white">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="aiTipsButtonText">✨ Get AI Maintenance Tips</span>
                </button>

                <div id="aiMaintenanceTipsOutput" class="hidden mt-4 p-4 bg-zinc-800 rounded-lg border border-orange-600 text-gray-200 whitespace-pre-wrap">
                    <h4 class="font-semibold text-orange-300 mb-2 text-center">AI Maintenance Insights</h4>
                </div>
            </div>
        </div>

        <!-- Replacement Gear Modal -->
        <div id="replacementGearModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div class="bg-zinc-900 text-white p-6 rounded-xl shadow-2xl max-w-md w-full relative border-t-4 border-orange-500 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <button id="closeReplacementGearModal" class="absolute top-3 right-3 text-2xl text-gray-400 hover:text-white transition-colors" aria-label="Close">
                    &times;
                </button>
                <h2 id="replacementGearName" class="text-2xl font-bold mb-4 text-orange-400 text-center"></h2>
                <div id="replacementGearList" class="grid grid-cols-1 gap-4"></div>
                <p id="noReplacementSuggestions" class="hidden text-center text-gray-400">No replacement suggestions for this item yet.</p>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <footer class="fixed-bottom-nav bg-zinc-800 text-white flex justify-around items-center h-16 shadow-lg border-t border-orange-700 flex-shrink-0">
            <button id="navHome" class="flex flex-col items-center p-2 rounded-lg transition-colors text-orange-400" aria-label="Home">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2 2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="text-xs mt-1">Home</span>
            </button>

            <button id="navAddGear" class="flex flex-col items-center p-2 rounded-lg transition-colors text-gray-400 hover:text-orange-300" aria-label="Add Gear">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m0 0l-3-3m3 3l3-3m-3 3V9a9 9 0 110 18A9 9 0 0112 9z" />
                </svg>
                <span class="text-xs mt-1">Add Gear</span>
            </button>

            <button id="navMyGear" class="flex flex-col items-center p-2 rounded-lg transition-colors text-gray-400 hover:text-orange-300" aria-label="My Gear">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 14v6m-3-3h6m-9-11V4a1 1 0 011-1h2a1 1 0 011 1v3m-6 0h6a1 1 0 011 1v3a1 1 0 01-1 1h-6a1 1 0 01-1-1V8a1 1 0 011-1z" />
                </svg>
                <span class="text-xs mt-1">My Gear</span>
            </button>

            <button id="navProfile" class="flex flex-col items-center p-2 rounded-lg transition-colors text-gray-400 hover:text-orange-300" aria-label="Profile">
                <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="text-xs mt-1">Profile</span>
            </button>
        </footer>
    </div>

    <script>
        // --- Data Definitions (Same as React Version) ---
        const initialGearData = {
            Tennis: [
                { id: "tennis-racket-1", name: "Racket", brand: "Wilson Clash 100 V2", rating: 3, suggestion: "Average", lastReminderDate: "2025-06-15",
                  aiCommentary: "Your Wilson Clash 100 V2 shows visible frame wear near the throat, which can affect power strokes and stability, potentially leading to wrist strain. String tension feels loose, causing shots to fall deeper than expected. Consider restringing or replacement to prevent elbow tendonitis.",
                  injuries: [{ type: "Wrist Strain", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Wrist" }, { type: "Elbow Tendonitis", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Elbow" }],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Worn+Racket", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=Ideal+Racket", sport: "Tennis" },
                { id: "tennis-shoes-1", name: "Shoes", brand: "Nike Vapour Zoom v9", rating: 2, suggestion: "Replace", lastReminderDate: "2025-06-20",
                  aiCommentary: "Your Nike shoes show significant wear on the inside sole, which is the critical landing spot for traction and stability. This uneven wear risks serious ankle sprains and reduced court grip, impacting quick directional changes. Heel cushioning is also compressed, increasing impact on knees.",
                  injuries: [{ type: "Ankle Sprain", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Ankle" }, {type: "Knee Impact", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Knee"}],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Worn+Shoes", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=Ideal+Shoes", sport: "Tennis" },
                { id: "tennis-balls-1", name: "Balls", brand: "Wilson Premier Court", rating: 4, suggestion: "Good",
                  aiCommentary: "Balls are in decent shape with consistent bounce. Minimal fuzzing indicates they still offer good aerodynamics for predictable shots. Keep monitoring for pressure loss or excessive fuzz.",
                  injuries: [],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Used+Balls", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Balls", sport: "Tennis" },
                { id: "tennis-court-1", name: "Court", brand: "Hard Court", rating: 3, suggestion: "Average",
                  aiCommentary: "Some surface cracks observed, especially near the baseline. Ensure shoes with adequate grip are used to avoid slipping during aggressive play. Uneven surfaces can increase risk of twisted ankles or knee bruises.",
                  injuries: [{ type: "Knee Bruise", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Knee" }, {type: "Ankle Twist", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Ankle"}],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Current+Court", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=Perfect+Court", sport: "Tennis" },
            ],
            Badminton: [
                { id: "badminton-racket-1", name: "Racket", brand: "Yonex Astrox 88S", rating: 4, suggestion: "Good",
                  aiCommentary: "Strings are taut and show good tension, frame shows minimal wear. This racket is in good condition for continued precise shots and powerful smashes.",
                  injuries: [],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Used+Badminton+Racket", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Badminton+Racket", sport: "Badminton" },
                { id: "badminton-shoes-1", name: "Shoes", brand: "Li-Ning Saga", rating: 3, suggestion: "Average",
                  aiCommentary: "Sole grip is slightly worn, particularly on the forefoot. This could compromise quick lateral movements and increase the risk of ankle twists. Consider cleaning or replacing for optimal court traction.",
                  injuries: [{ type: "Ankle Twist", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Ankle" }],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Used+Badminton+Shoes", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Badminton+Shoes", sport: "Badminton" },
            ],
            Running: [
                { id: "running-shoes-1", name: "Shoes", brand: "Brooks Ghost 14", rating: 2, suggestion: "Replace", lastReminderDate: "2025-06-25",
                  aiCommentary: "Midsole compression is high, especially under the heel and forefoot, indicating lost cushioning. Outsole tread is significantly worn, reducing grip on varied surfaces. Replace soon to prevent knee and joint pain, and reduce risk of slips.",
                  injuries: [{ type: "Knee Pain", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Knee" }, { type: "Shin Splints", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Shin" }],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Worn+Running+Shoes", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Running+Shoes", sport: "Running" },
                { id: "running-watch-1", name: "Watch", brand: "Garmin Forerunner 245", rating: 5, suggestion: "Excellent",
                  aiCommentary: "Device is in excellent condition, no visible wear or scratches on the screen or band. All sensors appear functional.",
                  injuries: [],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Current+Watch", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Watch", sport: "Running" },
            ],
            Squash: [
                { id: "squash-racket-1", name: "Racket", brand: "Head Graphene XT", rating: 3, suggestion: "Average",
                  aiCommentary: "Some string fraying is visible, and minor frame scratches indicate impact. Consider restringing soon to maintain shot power and control. Continued use with frayed strings can lead to wrist strain.",
                  injuries: [{ type: "Wrist Strain", image: "https://placehold.co/40x40/FF5722/FFFFFF?text=Wrist" }],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Used+Squash+Racket", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Squash+Racket", sport: "Squash" },
                { id: "squash-balls-1", name: "Balls", brand: "Dunlop Pro", rating: 4, suggestion: "Good",
                  aiCommentary: "Balls retain good bounce and minimal scuffing. They are still suitable for competitive play. Store properly to maintain pressure.",
                  injuries: [],
                  currentImage: "https://placehold.co/100x100/333333/FFFFFF?text=Used+Squash+Balls", idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Squash+Balls", sport: "Squash" },
            ],
        };

        const replacementGearData = {
            Racket: [
                { id: "repl-racket-1", name: "New Gen Racket X", price: "$250", status: "On Sale!", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Racket+X" },
                { id: "repl-racket-2", name: "Pro Series Racket Y", price: "$300", status: "New Arrival", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Pro+Racket+Y" },
                { id: "repl-racket-3", name: "Carbon Fiber Pro", price: "$280", status: "Limited Stock", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Carbon+Racket" },
            ],
            Shoes: [
                { id: "repl-shoes-1", name: "Court Master Z", price: "$120", status: "Best Seller", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=New+Shoes+Z" },
                { id: "repl-shoes-2", name: "Agility Runner A", price: "$150", status: "Limited Stock", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Agility+Shoes" },
                { id: "repl-shoes-3", name: "Speedster Pro", price: "$135", status: "Flash Sale", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Speedster+Shoes" },
            ],
            Balls: [
                { id: "repl-balls-1", name: "Premium Bounce Pack", price: "$25", status: "Bulk Deal", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Premium+Balls" },
                { id: "repl-balls-2", name: "Tournament Grade 3-Pack", price: "$10", status: "New Stock", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Tour+Balls" },
            ],
        };

        const mockPopularGearFromInternet = {
            Racket: [
                { id: "pop-racket-1", brand: "Babolat", name: "Pure Aero", price: "$239.99", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Babolat+Aero" },
                { id: "pop-racket-2", brand: "Head", name: "Speed Pro", price: "$229.00", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Head+Speed" },
                { id: "pop-racket-3", brand: "Wilson", name: "Blade 98", price: "$219.50", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Wilson+Blade" },
                { id: "pop-racket-4", brand: "Yonex", name: "Ezone 98", price: "$249.00", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Yonex+Ezone" },
            ],
            Shoes: [
                { id: "pop-shoes-1", brand: "Adidas", name: "Barricade", price: "$130.00", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Adidas+Barricade" },
                { id: "pop-shoes-2", brand: "Asics", name: "Gel-Resolution 9", price: "$145.00", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Asics+Gel" },
                { id: "pop-shoes-3", brand: "New Balance", name: "FuelCell 996v5", price: "$125.00", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=NB+FuelCell" },
                { id: "pop-shoes-4", brand: "Nike", name: "Court Zoom Vapor Cage 4", price: "$150.00", image: "https://placehold.co/100x100/FF5722/FFFFFF?text=Nike+Vapor" },
            ],
        };

        // Helper to flatten initialGearData into a single list with sport property
        const getInitialEquipmentList = () => {
            let list = [];
            for (const sport in initialGearData) {
                initialGearData[sport].forEach(item => {
                    list.push({ ...item, id: `${sport.toLowerCase()}-${item.name.toLowerCase()}-${Date.now()}-${Math.random().toString(36).substring(2, 8)}` });
                });
            }
            return list;
        };

        // --- Global State and Variables ---
        // Using an object to hold state for easier management in plain JS
        const appState = {
            appMode: 'sportsSelection', // 'sportsSelection', 'sportDashboard', 'summaryView', 'injuriesAvoidedDetail', 'gameImprovementDetail', 'gearList', 'addGear'
            selectedSport: null,
            commentaryGear: null,
            equipmentList: getInitialEquipmentList(),
            showReplacementGear: false,
            showIndividualAnalysisButtons: false,
            aiMaintenanceTips: null,
            aiTipsLoading: false,
            selectedPopularGearType: 'Racket', // For popular gear list selection
            newGearName: '',
            newGearType: 'Racket',
            newGearSport: 'Tennis',
            uploadedImageFile: null,
            autoTagResult: null,
        };

        const mainContent = document.getElementById('mainContent');
        const aiCommentaryModal = document.getElementById('aiCommentaryModal');
        const replacementGearModal = document.getElementById('replacementGearModal');

        // --- Helper Functions ---

        function render() {
            mainContent.innerHTML = ''; // Clear current content
            updateBottomNav();

            if (appState.appMode === 'sportsSelection') {
                renderSportsSelection();
            } else if (appState.appMode === 'sportDashboard') {
                renderSportDashboard();
            } else if (appState.appMode === 'summaryView') {
                renderSummaryView();
            } else if (appState.appMode === 'injuriesAvoidedDetail') {
                renderInjuriesAvoidedDetail();
            } else if (appState.appMode === 'gameImprovementDetail') {
                renderGameImprovementDetail();
            } else if (appState.appMode === 'gearList') {
                renderGearList();
            } else if (appState.appMode === 'addGear') {
                renderAddGear();
            }

            // Manage modal visibility
            aiCommentaryModal.classList.toggle('hidden', !appState.commentaryGear);
            replacementGearModal.classList.toggle('hidden', !appState.showReplacementGear);
        }

        function navigate(mode, sport = null) {
            appState.appMode = mode;
            appState.selectedSport = sport;
            appState.commentaryGear = null;
            appState.showReplacementGear = false;
            appState.showIndividualAnalysisButtons = false;
            appState.aiMaintenanceTips = null;
            appState.aiTipsLoading = false;
            appState.newGearName = '';
            appState.newGearType = 'Racket';
            appState.newGearSport = 'Tennis';
            appState.uploadedImageFile = null;
            appState.autoTagResult = null;
            appState.selectedPopularGearType = 'Racket';
            render();
        }

        function updateBottomNav() {
            document.querySelectorAll('footer button').forEach(button => {
                button.classList.remove('text-orange-400');
                button.classList.add('text-gray-400', 'hover:text-orange-300');
            });

            if (appState.appMode === 'sportsSelection') {
                document.getElementById('navHome').classList.add('text-orange-400');
            } else if (appState.appMode === 'addGear') {
                document.getElementById('navAddGear').classList.add('text-orange-400');
            } else if (appState.appMode === 'gearList' || appState.appMode === 'sportDashboard' || appState.appMode === 'summaryView' || appState.appMode === 'injuriesAvoidedDetail' || appState.appMode === 'gameImprovementDetail') {
                document.getElementById('navMyGear').classList.add('text-orange-400');
            }
        }

        // --- Render Functions for each View ---

        function renderSportsSelection() {
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4';
            Object.keys(initialGearData).forEach(sport => {
                const card = document.createElement('div');
                card.className = 'bg-orange-700 text-white rounded-xl shadow-lg cursor-pointer hover:bg-orange-800 transition-colors duration-300 transform hover:scale-105';
                card.innerHTML = `<div class="p-6 text-center font-semibold text-lg">${sport}</div>`;
                card.onclick = () => navigate('sportDashboard', sport);
                grid.appendChild(card);
            });
            mainContent.appendChild(grid);
        }

        function renderSportDashboard() {
            const div = document.createElement('div');
            div.className = 'p-2';
            div.innerHTML = `
                <div class="flex items-center mb-6">
                    <button class="p-2 rounded-full hover:bg-zinc-700 transition-colors mr-2" onclick="navigate('sportsSelection')" aria-label="Back to Sports">
                        <svg class="w-6 h-6 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-orange-400">${appState.selectedSport} Dashboard</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4" id="dashboardOptions"></div>
            `;
            mainContent.appendChild(div);

            const dashboardOptions = div.querySelector('#dashboardOptions');
            [
                { name: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-orange-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>', description: 'Overview of your activities and stats.' },
                { name: 'Gear Health', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-orange-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>', description: 'Detailed analysis of your equipment condition.' },
                { name: 'Buy Gear', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-orange-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>', description: 'Find new and recommended equipment.' },
                { name: 'Trade Gear', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-orange-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4l-4 4m0 0l4 4m-4-4h14" /></svg>', description: 'Exchange or sell your used equipment.' },
                { name: 'Tips to Improve', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-orange-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 17v5m-4.5-1.5h9m-11.487-10.325A4.5 4.5 0 0112 4.5c1.932 0 3.597 1.126 4.312 2.733.715 1.607.28 3.493-1.11 4.5V13.5a2.25 2.25 0 01-2.25 2.25h-1.5a2.25 2.25 0 01-2.25-2.25V11.25c-1.39-.977-1.82-2.863-1.11-4.5z" /></svg>', description: 'Get insights and articles for better play.' },
                { name: 'Get Coached', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-orange-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 14l9-5-9-5-9 5 9 5zm0 0v4l-9 5V19l9-5zm0 0v4l9 5V19l-9-5z" /></svg>', description: 'Connect with expert coaches for personalized guidance.' },
            ].forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'bg-zinc-900 text-white rounded-xl shadow-lg p-6 cursor-pointer hover:bg-zinc-800 transition-colors duration-300 transform hover:scale-105 flex flex-col items-center text-center justify-center min-h-[120px]';
                optionDiv.innerHTML = `
                    ${option.icon}
                    <h3 class="text-xl font-bold text-orange-300 mb-1">${option.name}</h3>
                    <p class="text-sm text-gray-400">${option.description}</p>
                `;
                optionDiv.onclick = () => {
                    if (option.name === 'Gear Health') {
                        navigate('gearList', appState.selectedSport);
                    } else if (option.name === 'Dashboard') {
                        navigate('summaryView', appState.selectedSport);
                    } else {
                        alert(`'${option.name}' feature coming soon!`);
                    }
                };
                dashboardOptions.appendChild(optionDiv);
            });
        }

        function renderSummaryView() {
            const currentDate = new Date('2025-07-03'); // Mock current date

            const urgentReplacementGear = appState.equipmentList.filter(item => item.suggestion === 'Replace');
            const alerts = urgentReplacementGear.map(item => {
                let daysSince = 'N/A';
                if (item.lastReminderDate) {
                    const reminderDate = new Date(item.lastReminderDate);
                    const diffTime = Math.abs(currentDate.getTime() - reminderDate.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    daysSince = diffDays;
                }
                return {
                    id: item.id,
                    type: 'warning',
                    message: `${item.name} (${item.brand}) needs urgent replacement. Reminder sent ${daysSince} days ago.`,
                    daysSinceReminder: daysSince,
                };
            });

            if (alerts.length === 0) {
                alerts.push({ id: 'no-urgent-gear', type: 'info', message: 'No urgent gear replacements needed at this time!' });
                alerts.push({ id: 'general-tip', type: 'success', message: 'All your current gear is in good health or being monitored.' });
            }
            alerts.push({ id: 'general-tip-2', type: 'info', message: 'Remember to check your string tension regularly for optimal play.' });

            const mockSummaryData = {
                alerts: alerts,
                recentActivities: [
                    { id: 1, activity: 'Logged Tennis session', date: '2025-07-01' },
                    { id: 2, activity: 'Viewed Racket analysis', date: '2025-06-30' },
                    { id: 3, activity: 'Added new running shoes', date: '2025-06-28' },
                ],
                injuriesAvoided: 5,
                gameImprovementScore: 15,
                overallGearHealth: 'Good',
            };

            const div = document.createElement('div');
            div.className = 'p-2';
            div.innerHTML = `
                <div class="flex items-center mb-6">
                    <button class="p-2 rounded-full hover:bg-zinc-700 transition-colors mr-2" onclick="navigate('sportDashboard', '${appState.selectedSport}')" aria-label="Back to Dashboard">
                        <svg class="w-6 h-6 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-orange-400">${appState.selectedSport} Summary</h2>
                </div>

                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-6 border border-zinc-700 text-center">
                    <h3 class="text-xl font-bold text-orange-300 mb-2">Overall Gear Health</h3>
                    <p class="text-4xl font-extrabold text-orange-500">${mockSummaryData.overallGearHealth}</p>
                    <p class="text-gray-400 text-sm mt-1">Based on recent analyses</p>
                </div>

                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-6 border border-zinc-700">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Alerts</h3>
                    <div class="space-y-3">
                        ${mockSummaryData.alerts.map(alert => `
                            <div class="p-3 rounded-lg flex items-center gap-3 ${
                                alert.type === 'warning' ? 'bg-yellow-900 text-yellow-200 border border-yellow-700' : ''
                            }${
                                alert.type === 'info' ? 'bg-blue-900 text-blue-200 border border-blue-700' : ''
                            }${
                                alert.type === 'success' ? 'bg-green-900 text-green-200 border border-green-700' : ''
                            }">
                                ${alert.type === 'warning' ? '<span role="img" aria-label="warning">⚠️</span>' : ''}
                                ${alert.type === 'info' ? '<span role="img" aria-label="info">ℹ️</span>' : ''}
                                ${alert.type === 'success' ? '<span role="img" aria-label="success">✅</span>' : ''}
                                <p class="text-sm flex-grow">${alert.message}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-6 border border-zinc-700">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Urgent Replacement Needed</h3>
                    ${urgentReplacementGear.length > 0 ? `
                        <div class="space-y-3">
                            ${urgentReplacementGear.map(gear => `
                                <div class="p-3 bg-red-900 text-red-200 rounded-lg border border-red-700 flex items-center gap-3">
                                    <span role="img" aria-label="alert">🚨</span>
                                    <p class="text-sm flex-grow">
                                        <strong>${gear.name} (${gear.brand})</strong> - Needs replacement.
                                        ${gear.lastReminderDate ? ` Reminder sent ${gear.daysSinceReminder} days ago.` : ''}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    ` : `<p class="text-gray-400 text-center">No gear requires urgent replacement.</p>`}
                </div>

                <div id="injuriesAvoidedCard" class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-6 border border-zinc-700 text-center cursor-pointer hover:bg-zinc-800 transition-colors">
                    <h3 class="text-xl font-bold text-orange-300 mb-2">Injuries Avoided</h3>
                    <p class="text-4xl font-extrabold text-green-500">${mockSummaryData.injuriesAvoided}</p>
                    <p class="text-gray-400 text-sm mt-1">Due to proactive gear replacement</p>
                </div>

                <div id="gameImprovementCard" class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-6 border border-zinc-700 text-center cursor-pointer hover:bg-zinc-800 transition-colors">
                    <h3 class="text-xl font-bold text-orange-300 mb-2">Overall Game Improvement</h3>
                    <p class="text-4xl font-extrabold text-blue-400">${mockSummaryData.gameImprovementScore}%</p>
                    <p class="text-gray-400 text-sm mt-1">Based on coaching inputs & performance tracking</p>
                </div>

                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg border border-zinc-700">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Recent Activities</h3>
                    ${mockSummaryData.recentActivities.length > 0 ? `
                        <div class="space-y-2">
                            ${mockSummaryData.recentActivities.map(activity => `
                                <div class="flex justify-between items-center text-gray-300 text-sm">
                                    <span>${activity.activity}</span>
                                    <span class="text-gray-500">${activity.date}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : `<p class="text-gray-400 text-center">No recent activities.</p>`}
                </div>
            `;
            mainContent.appendChild(div);

            // Add event listeners for the new clickable cards
            document.getElementById('injuriesAvoidedCard').onclick = () => navigate('injuriesAvoidedDetail', appState.selectedSport);
            document.getElementById('gameImprovementCard').onclick = () => navigate('gameImprovementDetail', appState.selectedSport);
        }

        function renderInjuriesAvoidedDetail() {
            const div = document.createElement('div');
            div.className = 'p-2';
            div.innerHTML = `
                <div class="flex items-center mb-6">
                    <button class="p-2 rounded-full hover:bg-zinc-700 transition-colors mr-2" onclick="navigate('summaryView', '${appState.selectedSport}')" aria-label="Back to Summary">
                        <svg class="w-6 h-6 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-orange-400">${appState.selectedSport} Injuries Avoided</h2>
                </div>

                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-6 border border-zinc-700">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Details of Avoided Injuries</h3>
                    <div class="space-y-4">
                        <div class="p-3 bg-green-900 text-green-200 rounded-lg border border-green-700">
                            <p class="font-semibold">Ankle Sprain Avoided (Tennis Shoes)</p>
                            <p class="text-sm mt-1">By replacing your Nike Vapour Zoom v9 shoes on time, you avoided a potential severe ankle sprain due to worn-out sole traction.</p>
                        </div>
                        <div class="p-3 bg-green-900 text-green-200 rounded-lg border border-green-700">
                            <p class="font-semibold">Elbow Tendonitis Prevented (Tennis Racket)</p>
                            <p class="text-sm mt-1">Early restringing of your Wilson Clash 100 V2 racket prevented chronic elbow tendonitis caused by inconsistent string tension.</p>
                        </div>
                        <div class="p-3 bg-green-900 text-green-200 rounded-lg border border-green-700">
                            <p class="font-semibold">Knee Pain Averted (Running Shoes)</p>
                            <p class="text-sm mt-1">Upgrading your Brooks Ghost 14 running shoes due to degraded midsole cushioning helped avoid repetitive stress knee pain during long runs.</p>
                        </div>
                    </div>
                </div>
            `;
            mainContent.appendChild(div);
        }

        function renderGameImprovementDetail() {
            const div = document.createElement('div');
            div.className = 'p-2';
            div.innerHTML = `
                <div class="flex items-center mb-6">
                    <button class="p-2 rounded-full hover:bg-zinc-700 transition-colors mr-2" onclick="navigate('summaryView', '${appState.selectedSport}')" aria-label="Back to Summary">
                        <svg class="w-6 h-6 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-orange-400">${appState.selectedSport} Game Improvement</h2>
                </div>

                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-6 border border-zinc-700">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Game Improvement Details</h3>
                    <div class="space-y-4 text-gray-300">
                        <p>Based on the latest video analysis uploaded on 2025-06-28 and subsequent coaching inputs:</p>
                        <ul class="list-disc list-inside space-y-2 ml-4">
                            <li>Your overall shot-making power has improved considerably, showing a 10% increase in average ball speed.</li>
                            <li>Footwork efficiency has seen a 5% improvement, leading to better court coverage.</li>
                            <li>Serve consistency is up by 8%, with fewer double faults.</li>
                            <li>These improvements are directly linked to the insights gained from personalized coaching sessions focusing on your technique and strategy.</li>
                        </ul>
                        <p class="mt-4 text-gray-400">Keep uploading videos to track your progress and get more tailored advice!</p>
                    </div>
                </div>
            `;
            mainContent.appendChild(div);
        }


        function renderGearList() {
            const div = document.createElement('div');
            div.className = 'p-2';
            div.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <button class="p-2 rounded-full hover:bg-zinc-700 transition-colors mr-2" onclick="navigate('sportDashboard', '${appState.selectedSport}')" aria-label="Back to Dashboard">
                            <svg class="w-6 h-6 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                            </svg>
                        </button>
                        <h2 class="text-2xl font-semibold text-orange-400">${appState.selectedSport} Gear</h2>
                    </div>
                    <button id="toggleAnalysisButtons" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-600 transition-colors duration-300 text-sm">
                        ${appState.showIndividualAnalysisButtons ? 'Hide AI Analysis' : 'Check AI Analysis on Gear'}
                    </button>
                </div>
                <div id="gearListContent"></div>
            `;
            mainContent.appendChild(div);

            const gearListContent = div.querySelector('#gearListContent');
            const filteredEquipment = appState.equipmentList.filter(item => item.sport === appState.selectedSport); // Filter dynamically

            if (filteredEquipment.length === 0) {
                gearListContent.innerHTML = `<p class="text-gray-400 text-center mt-8">No gear added for ${appState.selectedSport} yet. Add some!</p>`;
            } else {
                filteredEquipment.forEach(item => {
                    const gearCard = document.createElement('div');
                    gearCard.className = 'mb-4 bg-zinc-900 text-white rounded-xl shadow-lg p-4 border border-zinc-700';
                    gearCard.innerHTML = `
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <div class="mb-3 sm:mb-0 flex-grow">
                                <h3 class="text-xl font-bold text-orange-300">${item.name}</h3>
                                <p class="text-sm text-gray-300">${item.brand}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <p class="text-sm text-gray-300">Condition: <span class="font-semibold">${item.rating} / 5</span></p>
                                    <div class="bg-orange-800 text-orange-200 font-bold px-3 py-1 rounded-full text-xs flex-shrink-0">
                                        ${item.suggestion}
                                    </div>
                                </div>
                            </div>
                            <button class="view-analysis-button bg-zinc-700 text-gray-300 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-zinc-600 transition-colors duration-300 flex-shrink-0 text-sm mt-2 sm:mt-0 ${appState.showIndividualAnalysisButtons ? '' : 'hidden'}">
                                View Analysis
                            </button>
                        </div>
                    `;
                    gearCard.querySelector('.view-analysis-button').onclick = () => openCommentaryModal(item);
                    gearListContent.appendChild(gearCard);
                });
            }

            div.querySelector('#toggleAnalysisButtons').onclick = () => {
                appState.showIndividualAnalysisButtons = !appState.showIndividualAnalysisButtons;
                render(); // Re-render to update button visibility
            };
        }

        function renderAddGear() {
            const div = document.createElement('div');
            div.className = 'p-2';
            div.innerHTML = `
                <div class="flex items-center mb-6">
                    <button class="p-2 rounded-full hover:bg-zinc-700 transition-colors mr-2" onclick="navigate('sportsSelection')" aria-label="Back to Sports">
                        <svg class="w-6 h-6 text-orange-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-semibold text-orange-400">Add New Gear</h2>
                </div>

                <!-- Manual Addition Section -->
                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg mb-8 border border-zinc-700">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Add Manually</h3>
                    <input type="text" id="newGearName" placeholder="Gear Name (e.g., My New Racket)" class="w-full p-3 mb-3 bg-zinc-800 border border-zinc-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${appState.newGearName}" />
                    <select id="newGearType" class="w-full p-3 mb-3 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500" value="${appState.newGearType}">
                        <option value="Racket">Racket</option>
                        <option value="Shoes">Shoes</option>
                        <option value="Balls">Balls</option>
                        <option value="Court">Court</option>
                    </select>
                    <select id="newGearSport" class="w-full p-3 mb-4 bg-zinc-800 border border-zinc-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500" value="${appState.newGearSport}">
                        ${Object.keys(initialGearData).map(sport => `<option value="${sport}">${sport}</option>`).join('')}
                    </select>
                    <button id="addManualGearButton" class="bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg shadow-md w-full hover:bg-orange-600 transition-colors duration-300">
                        Add Gear Manually
                    </button>
                </div>

                <!-- Photo Upload & Auto-Tagging Section -->
                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg border border-zinc-700 mb-8">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Upload Photo for Auto-Tagging</h3>
                    <label for="photo-upload" class="flex items-center justify-center p-4 mb-4 bg-zinc-800 border-2 border-dashed border-orange-500 rounded-lg cursor-pointer hover:bg-zinc-700 transition-colors duration-300 text-orange-400">
                        <svg class="w-8 h-8 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span>Click to Upload Photo</span>
                        <input id="photo-upload" type="file" accept="image/*" class="hidden" />
                    </label>

                    <div id="uploadedImageContainer" class="${appState.uploadedImageFile ? '' : 'hidden'} text-center mb-4">
                        <p class="text-gray-400 mb-2">Uploaded Image:</p>
                        <img id="uploadedImagePreview" src="${appState.uploadedImageFile || ''}" alt="Uploaded" class="max-h-40 mx-auto rounded-lg border border-zinc-700" />
                    </div>

                    <div id="autoTagResultContainer" class="${appState.autoTagResult || appState.aiTipsLoading ? '' : 'hidden'} mt-4 p-4 bg-zinc-800 rounded-lg border border-orange-600 text-center">
                        <p class="text-orange-200 font-semibold mb-2">AI Detected:</p>
                        <p id="autoTagResultText" class="text-lg text-white font-bold">${appState.autoTagResult ? `${appState.autoTagResult.detectedType} for ${appState.autoTagResult.detectedSport}` : 'Detecting...'}</p>
                        <button id="addAutoTaggedGearButton" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md mt-4 hover:bg-orange-600 transition-colors duration-300 ${appState.autoTagResult ? '' : 'hidden'}" ${appState.aiTipsLoading ? 'disabled' : ''}>
                            Add Auto-Tagged Gear to Profile
                        </button>
                    </div>
                </div>

                <!-- Browse Popular Gear Section -->
                <div class="bg-zinc-900 p-6 rounded-xl shadow-lg border border-zinc-700">
                    <h3 class="text-xl font-bold text-orange-300 mb-4">Browse Popular Gear</h3>
                    <div class="flex justify-center gap-2 mb-4" id="popularGearTypeButtons">
                        <button class="px-4 py-2 rounded-lg font-semibold text-sm transition-colors duration-200 ${appState.selectedPopularGearType === 'Racket' ? 'bg-orange-600 text-white' : 'bg-zinc-700 text-gray-300 hover:bg-zinc-600'}" data-type="Racket">Rackets</button>
                        <button class="px-4 py-2 rounded-lg font-semibold text-sm transition-colors duration-200 ${appState.selectedPopularGearType === 'Shoes' ? 'bg-orange-600 text-white' : 'bg-zinc-700 text-gray-300 hover:bg-zinc-600'}" data-type="Shoes">Shoes</button>
                    </div>
                    <div id="popularGearList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                </div>
            `;
            mainContent.appendChild(div);

            // Event Listeners for Add Gear Page
            document.getElementById('addManualGearButton').onclick = handleAddManualGear;
            document.getElementById('photo-upload').onchange = handlePhotoUploadForTagging;
            document.getElementById('addAutoTaggedGearButton').onclick = handleAddAutoTaggedGear;
            
            document.getElementById('popularGearTypeButtons').querySelectorAll('button').forEach(button => {
                button.onclick = (e) => {
                    appState.selectedPopularGearType = e.target.dataset.type;
                    document.getElementById('popularGearTypeButtons').querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('bg-orange-600', 'text-white');
                        btn.classList.add('bg-zinc-700', 'text-gray-300', 'hover:bg-zinc-600');
                    });
                    // Corrected class manipulation
                    e.target.classList.remove('bg-zinc-700', 'text-gray-300', 'hover:bg-zinc-600');
                    e.target.classList.add('bg-orange-600', 'text-white');
                    renderPopularGearList();
                };
            });
            renderPopularGearList(); // Initial render of popular gear
        }


        // --- Modal Functions ---

        function openCommentaryModal(item) {
            appState.commentaryGear = item;
            document.getElementById('commentaryGearName').textContent = `${item.name} Analysis`;
            document.getElementById('commentaryAiCommentary').textContent = item.aiCommentary;
            document.getElementById('commentaryCurrentImage').src = item.currentImage;
            document.getElementById('commentaryIdealImage').src = item.idealImage;

            const injuryList = document.getElementById('injuryList');
            injuryList.innerHTML = '';
            if (item.injuries && item.injuries.length > 0) {
                document.getElementById('commentaryInjuries').classList.remove('hidden');
                item.injuries.forEach(inj => {
                    const injuryDiv = document.createElement('div');
                    injuryDiv.className = 'text-center flex flex-col items-center';
                    injuryDiv.innerHTML = `
                        <img src="${inj.image}" alt="${inj.type}" class="h-10 w-10 object-contain mx-auto mb-1" onerror="this.onerror=null;this.src='https://placehold.co/40x40/FF5722/FFFFFF?text=?';" />
                        <p class="text-xs text-gray-400">${inj.type}</p>
                    `;
                    injuryList.appendChild(injuryDiv);
                });
            } else {
                document.getElementById('commentaryInjuries').classList.add('hidden');
            }

            // Show/hide "Check Replacement Gear" button
            const checkReplacementBtn = document.getElementById('checkReplacementGearButton');
            if (item.name === "Racket" || item.name === "Shoes" || item.name === "Balls") {
                checkReplacementBtn.classList.remove('hidden');
                checkReplacementBtn.onclick = () => openReplacementGearModal(item);
            } else {
                checkReplacementBtn.classList.add('hidden');
            }

            // Reset AI Maintenance Tips section
            document.getElementById('aiMaintenanceTipsOutput').classList.add('hidden');
            document.getElementById('aiMaintenanceTipsOutput').innerHTML = '<h4 class="font-semibold text-orange-300 mb-2 text-center">AI Maintenance Insights</h4>';
            document.getElementById('aiTipsButtonText').textContent = '✨ Get AI Maintenance Tips';
            document.getElementById('aiTipsSpinner').classList.add('hidden');


            aiCommentaryModal.classList.remove('hidden');
        }

        function closeCommentaryModal() {
            appState.commentaryGear = null;
            aiCommentaryModal.classList.add('hidden');
            appState.showReplacementGear = false; // Ensure replacement modal is also closed
            appState.aiMaintenanceTips = null;
            appState.aiTipsLoading = false;
            render(); // Re-render to clear any lingering modal state
        }

        function openReplacementGearModal(item) {
            appState.showReplacementGear = true;
            document.getElementById('replacementGearName').textContent = `Replacement ${item.name} Suggestions`;
            const replacementListContainer = document.getElementById('replacementGearList');
            replacementListContainer.innerHTML = '';
            document.getElementById('noReplacementSuggestions').classList.add('hidden');

            if (replacementGearData[item.name] && replacementGearData[item.name].length > 0) {
                replacementGearData[item.name].forEach(replItem => {
                    const replDiv = document.createElement('div');
                    replDiv.className = 'bg-zinc-800 p-3 rounded-lg flex items-center gap-4 border border-zinc-700';
                    replDiv.innerHTML = `
                        <img src="${replItem.image}" alt="${replItem.name}" class="h-16 w-16 object-contain rounded-md border border-zinc-600" onerror="this.onerror=null;this.src='https://placehold.co/64x64/333333/FFFFFF?text=Item';" />
                        <div class="flex-grow">
                            <h3 class="text-lg font-semibold text-orange-200">${replItem.name}</h3>
                            <p class="text-sm text-gray-300">Price: ${replItem.price}</p>
                            <p class="text-xs text-gray-400">${replItem.status}</p>
                        </div>
                        <button class="bg-orange-600 text-white px-3 py-1 rounded-md text-sm hover:bg-orange-700 transition-colors">
                            View
                        </button>
                    `;
                    replacementListContainer.appendChild(replDiv);
                });
            } else {
                document.getElementById('noReplacementSuggestions').classList.remove('hidden');
            }
            replacementGearModal.classList.remove('hidden');
        }

        function closeReplacementGearModal() {
            appState.showReplacementGear = false;
            replacementGearModal.classList.add('hidden');
            render(); // Re-render to clear any lingering modal state
        }

        // --- Event Handlers for Add Gear Page ---
        function handleAddManualGear() {
            const nameInput = document.getElementById('newGearName');
            const typeSelect = document.getElementById('newGearType');
            const sportSelect = document.getElementById('newGearSport');

            const name = nameInput.value.trim();
            const type = typeSelect.value;
            const sport = sportSelect.value;

            if (name && type && sport) {
                const newId = `${sport.toLowerCase()}-${type.toLowerCase()}-${Date.now()}`;
                const newGearItem = {
                    id: newId,
                    name: name,
                    brand: "User Added",
                    rating: 3,
                    suggestion: "Needs Analysis",
                    aiCommentary: "No AI analysis performed yet. Upload a photo!",
                    injuries: [],
                    currentImage: "https://placehold.co/100x100/555555/FFFFFF?text=No+Image",
                    idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=Ideal",
                    sport: sport,
                };
                appState.equipmentList.push(newGearItem); // Directly modify the array
                alert(`'${name}' (${type}) for ${sport} added!`);
                navigate('gearList', sport); // Go to gear list for the added sport
            } else {
                alert("Please fill in all manual gear details.");
            }
        }

        function handlePhotoUploadForTagging(event) {
            const file = event.target.files[0];
            if (file) {
                appState.uploadedImageFile = URL.createObjectURL(file);
                document.getElementById('uploadedImagePreview').src = appState.uploadedImageFile;
                document.getElementById('uploadedImageContainer').classList.remove('hidden');

                // Simulate AI processing and tagging
                document.getElementById('autoTagResultText').textContent = 'Detecting...';
                document.getElementById('autoTagResultContainer').classList.remove('hidden');
                document.getElementById('addAutoTaggedGearButton').disabled = true;

                setTimeout(() => {
                    const randomGearTypes = ['Racket', 'Shoes', 'Balls', 'Court'];
                    const randomSportTypes = ['Tennis', 'Badminton', 'Running', 'Squash'];
                    const detectedType = randomGearTypes[Math.floor(Math.random() * randomGearTypes.length)];
                    const detectedSport = randomSportTypes[Math.floor(Math.random() * randomSportTypes.length)];

                    appState.autoTagResult = {
                        detectedType,
                        detectedSport,
                        imageUrl: appState.uploadedImageFile,
                    };
                    document.getElementById('autoTagResultText').textContent = `${appState.autoTagResult.detectedType} for ${appState.autoTagResult.detectedSport}`;
                    document.getElementById('addAutoTaggedGearButton').disabled = false;
                }, 1500); // Simulate AI delay
            }
        }

        function handleAddAutoTaggedGear() {
            if (appState.autoTagResult) {
                const newId = `${appState.autoTagResult.detectedSport.toLowerCase()}-${appState.autoTagResult.detectedType.toLowerCase()}-${Date.now()}`;
                const newGearItem = {
                    id: newId,
                    name: appState.autoTagResult.detectedType,
                    brand: "Auto-Tagged",
                    rating: 3,
                    suggestion: "Needs Analysis",
                    aiCommentary: "No AI analysis performed yet. Upload a photo!",
                    injuries: [],
                    currentImage: appState.autoTagResult.imageUrl,
                    idealImage: "https://placehold.co/100x100/FF5722/FFFFFF?text=Ideal",
                    sport: appState.autoTagResult.detectedSport,
                };
                appState.equipmentList.push(newGearItem);
                alert(`Auto-tagged '${appState.autoTagResult.detectedType}' for ${appState.autoTagResult.detectedSport} added!`);
                navigate('gearList', appState.autoTagResult.detectedSport);
            }
        }

        function handleAddPopularGear(item) {
            const newId = `${item.brand.toLowerCase()}-${item.name.toLowerCase()}-${Date.now()}`;
            const newGearItem = {
                id: newId,
                name: item.name,
                brand: item.brand,
                rating: 4,
                suggestion: "New Gear",
                aiCommentary: "This is new gear! No wear detected yet. Enjoy your first sessions!",
                injuries: [],
                currentImage: item.image,
                idealImage: item.image,
                sport: "Tennis", // Assuming popular gear shown here is for Tennis for simplicity
            };
            appState.equipmentList.push(newGearItem);
            alert(`'${item.name}' added to your profile!`);
            navigate('gearList', 'Tennis');
        }

        // Gemini API call for AI Maintenance Tips
        async function getAiMaintenanceTips(gear) {
            appState.aiTipsLoading = true;
            appState.aiMaintenanceTips = null;
            document.getElementById('aiTipsSpinner').classList.remove('hidden');
            document.getElementById('aiTipsButtonText').textContent = 'Generating Tips...';
            document.getElementById('getAiMaintenanceTipsButton').disabled = true;
            document.getElementById('aiMaintenanceTipsOutput').classList.add('hidden'); // Hide previous output

            const prompt = `Based on the following AI analysis of a ${gear.name} (${gear.brand}): "${gear.aiCommentary}". Generate 3 specific, actionable maintenance tips for this equipment. Also, list 2 common FAQs about maintaining this type of gear and their brief answers. Format as:
            Maintenance Tips:
            - Tip 1
            - Tip 2
            - Tip 3
            
            FAQs:
            - Q1? A1.
            - Q2? A2.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    appState.aiMaintenanceTips = text;
                    document.getElementById('aiMaintenanceTipsOutput').innerHTML = `<h4 class="font-semibold text-orange-300 mb-2 text-center">AI Maintenance Insights</h4>${text}`;
                    document.getElementById('aiMaintenanceTipsOutput').classList.remove('hidden');
                } else {
                    appState.aiMaintenanceTips = "Could not generate tips. Please try again.";
                    document.getElementById('aiMaintenanceTipsOutput').innerHTML = `<h4 class="font-semibold text-orange-300 mb-2 text-center">AI Maintenance Insights</h4><p>${appState.aiMaintenanceTips}</p>`;
                    document.getElementById('aiMaintenanceTipsOutput').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                appState.aiMaintenanceTips = "Error generating tips. Please check console for details.";
                document.getElementById('aiMaintenanceTipsOutput').innerHTML = `<h4 class="font-semibold text-orange-300 mb-2 text-center">AI Maintenance Insights</h4><p>${appState.aiMaintenanceTips}</p>`;
                document.getElementById('aiMaintenanceTipsOutput').classList.remove('hidden');
            } finally {
                appState.aiTipsLoading = false;
                document.getElementById('aiTipsSpinner').classList.add('hidden');
                document.getElementById('aiTipsButtonText').textContent = '✨ Get AI Maintenance Tips';
                document.getElementById('getAiMaintenanceTipsButton').disabled = false;
            }
        }

        // --- Initial Render & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Global Nav Buttons
            document.getElementById('homeButtonHeader').onclick = () => navigate('sportsSelection');
            document.getElementById('navHome').onclick = () => navigate('sportsSelection');
            document.getElementById('navAddGear').onclick = () => navigate('addGear');
            document.getElementById('navMyGear').onclick = () => navigate('gearList', appState.selectedSport || Object.keys(initialGearData)[0]);
            document.getElementById('navProfile').onclick = () => alert("Profile coming soon!");

            // Modal Close Buttons
            aiCommentaryModal.onclick = closeCommentaryModal; // Click outside to close
            document.getElementById('closeCommentaryModal').onclick = closeCommentaryModal;
            replacementGearModal.onclick = closeReplacementGearModal; // Click outside to close
            document.getElementById('closeReplacementGearModal').onclick = closeReplacementGearModal;
            
            // AI Maintenance Tips button inside commentary modal
            document.getElementById('getAiMaintenanceTipsButton').onclick = () => getAiMaintenanceTips(appState.commentaryGear);


            render(); // Initial render of the app
        });
    </script>
</body>
</html>
